<% locals.pageTitle = 'Knowledge Base' %>

<div x-data="kbManager()" class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Pangkalan Pengetahuan</h1>
      <p class="mt-1 text-sm text-gray-500 dark:text-dark-400">Urus maklumat RAG untuk AI — semua jawapan AI datang dari sini</p>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <a href="/dashboard/knowledge/guide" class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl border border-gray-200 dark:border-dark-600 text-sm font-medium text-gray-700 dark:text-dark-300 hover:bg-gray-50 dark:hover:bg-dark-800 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
        <span class="hidden sm:inline">Panduan</span>
      </a>
      <button @click="showUploadModal = true" class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl border border-gray-200 dark:border-dark-600 text-sm font-medium text-gray-700 dark:text-dark-300 hover:bg-gray-50 dark:hover:bg-dark-800 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
        <span class="hidden sm:inline">Upload</span>
      </button>
      <button @click="showWaModal = true" class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl border border-green-300 dark:border-green-500/30 text-sm font-medium text-green-700 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-500/10 transition-colors">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18a8 8 0 01-4.243-1.214l-.252-.149-2.868.852.852-2.868-.149-.252A8 8 0 1112 20z"/></svg>
        <span class="hidden sm:inline">WhatsApp</span>
      </button>
      <button @click="openCreate()" class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl bg-primary-600 text-white text-sm font-medium hover:bg-primary-700 shadow-lg shadow-primary-500/25 transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        <span class="hidden sm:inline">Tambah</span>
      </button>
    </div>
  </div>

  <!-- Category Filter -->
  <div class="flex items-center gap-2 overflow-x-auto pb-1 -mx-1 px-1 scrollbar-hide">
    <a href="/dashboard/knowledge" class="px-3 py-1.5 rounded-lg text-xs font-medium transition-colors whitespace-nowrap <%= !selectedCategory ? 'bg-primary-100 text-primary-700 dark:bg-primary-500/20 dark:text-primary-400' : 'bg-gray-100 dark:bg-dark-800 text-gray-600 dark:text-dark-400 hover:bg-gray-200 dark:hover:bg-dark-700' %>">
      Semua
    </a>
    <% categories.forEach(cat => { %>
      <% const count = catCounts.find(c => c.category === cat.value)?._count || 0; %>
      <a href="/dashboard/knowledge?category=<%= cat.value %>" class="px-3 py-1.5 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5 whitespace-nowrap <%= selectedCategory === cat.value ? 'bg-primary-100 text-primary-700 dark:bg-primary-500/20 dark:text-primary-400' : 'bg-gray-100 dark:bg-dark-800 text-gray-600 dark:text-dark-400 hover:bg-gray-200 dark:hover:bg-dark-700' %>">
        <%= cat.label %>
        <% if (count > 0) { %><span class="text-[10px] opacity-60">(<%= count %>)</span><% } %>
      </a>
    <% }); %>
  </div>

  <!-- Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <% if (items.length === 0) { %>
      <div class="col-span-full flex flex-col items-center justify-center py-16">
        <svg class="w-12 h-12 text-gray-300 dark:text-dark-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
        <p class="text-sm text-gray-400 dark:text-dark-500">Tiada entri dalam pangkalan pengetahuan</p>
        <p class="text-xs text-gray-400 dark:text-dark-500 mt-1">Klik "Tambah Entri" atau "Upload Fail" untuk mula</p>
      </div>
    <% } %>
    <% items.forEach(item => { %>
      <div class="bg-white dark:bg-dark-800 rounded-2xl border border-gray-200 dark:border-dark-700 shadow-sm p-5 hover:shadow-md transition-shadow group">
        <div class="flex items-start justify-between mb-3">
          <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-[10px] font-semibold uppercase tracking-wider bg-primary-50 text-primary-700 dark:bg-primary-500/10 dark:text-primary-400"><%= item.category %></span>
          <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button @click="toggleActive(<%= item.id %>)" class="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700 transition-colors" title="<%= item.isActive ? 'Nyahaktifkan' : 'Aktifkan' %>">
              <span class="w-2 h-2 rounded-full inline-block <%= item.isActive ? 'bg-green-500' : 'bg-gray-300' %>"></span>
            </button>
            <button @click="openEdit(<%= item.id %>)" class="p-1.5 rounded-lg text-gray-400 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-500/10 transition-colors">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>
            <button @click="deleteEntry(<%= item.id %>)" class="p-1.5 rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
        <div class="flex items-center gap-2 mb-2">
          <% if (!item.isActive) { %><span class="text-[10px] text-red-400 bg-red-50 dark:bg-red-500/10 px-1.5 py-0.5 rounded">Tidak aktif</span><% } %>
          <h3 class="text-sm font-semibold text-gray-900 dark:text-white line-clamp-1"><%= item.title %></h3>
        </div>
        <p class="text-xs text-gray-500 dark:text-dark-400 line-clamp-3 leading-relaxed"><%= item.content %></p>
        <p class="text-[10px] text-gray-400 dark:text-dark-500 mt-3"><%= new Date(item.createdAt).toLocaleDateString('ms-MY') %> · <%= item.content.length %> aksara</p>
      </div>
    <% }); %>
  </div>

  <!-- Items data for JS -->
  <script>window.__kbItems = <%- JSON.stringify(items.map(i => ({id: i.id, category: i.category, title: i.title, content: i.content}))) %>;</script>

  <!-- Pagination -->
  <% if (totalPages > 1) { %>
    <div class="flex items-center justify-center gap-2 mt-6">
      <% if (page > 1) { %><a href="?page=<%= page - 1 %><%= selectedCategory ? '&category=' + selectedCategory : '' %>" class="px-4 py-2 rounded-xl text-xs font-medium bg-white dark:bg-dark-800 border border-gray-200 dark:border-dark-700 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors">Sebelum</a><% } %>
      <span class="px-3 py-2 text-xs text-gray-500 dark:text-dark-400"><%= page %> / <%= totalPages %></span>
      <% if (page < totalPages) { %><a href="?page=<%= page + 1 %><%= selectedCategory ? '&category=' + selectedCategory : '' %>" class="px-4 py-2 rounded-xl text-xs font-medium bg-white dark:bg-dark-800 border border-gray-200 dark:border-dark-700 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors">Seterusnya</a><% } %>
    </div>
  <% } %>

  <!-- Create/Edit Modal -->
  <div x-show="showModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" @click="showModal = false"></div>
    <div class="relative bg-white dark:bg-dark-800 rounded-2xl p-6 w-full max-w-lg shadow-2xl border border-gray-200 dark:border-dark-700">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-5" x-text="editId ? 'Edit Entri' : 'Tambah Entri Baru'"></h3>
      <form @submit.prevent="saveEntry()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-dark-300 mb-1">Kategori</label>
          <select x-model="form.category" required class="w-full px-3 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 bg-white dark:bg-dark-700 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500">
            <% categories.forEach(cat => { %>
              <option value="<%= cat.value %>"><%= cat.label %></option>
            <% }); %>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-dark-300 mb-1">Tajuk</label>
          <input type="text" x-model="form.title" required class="w-full px-3 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 bg-white dark:bg-dark-700 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-dark-300 mb-1">Kandungan</label>
          <textarea x-model="form.content" required rows="8" class="w-full px-3 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 bg-white dark:bg-dark-700 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none font-mono text-xs leading-relaxed"></textarea>
          <p class="text-[10px] text-gray-400 mt-1" x-text="`${(form.content || '').length} aksara`"></p>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="button" @click="showModal = false" class="flex-1 px-4 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 text-sm font-medium text-gray-700 dark:text-dark-300 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors">Batal</button>
          <button type="submit" :disabled="saving" class="flex-1 px-4 py-2.5 rounded-xl bg-primary-600 text-white text-sm font-medium hover:bg-primary-700 shadow-lg shadow-primary-500/25 transition-all disabled:opacity-50">
            <span x-text="saving ? 'Menyimpan...' : (editId ? 'Kemaskini' : 'Simpan')"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Upload Modal -->
  <div x-show="showUploadModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" @click="showUploadModal = false"></div>
    <div class="relative bg-white dark:bg-dark-800 rounded-2xl p-6 w-full max-w-lg shadow-2xl border border-gray-200 dark:border-dark-700">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Upload Fail</h3>
      <p class="text-xs text-gray-500 dark:text-dark-400 mb-5">PDF, Word (.doc/.docx), atau TXT — teks akan diekstrak secara automatik</p>
      <form @submit.prevent="uploadFile()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-dark-300 mb-1">Kategori</label>
          <select x-model="uploadForm.category" required class="w-full px-3 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 bg-white dark:bg-dark-700 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500">
            <% categories.forEach(cat => { %>
              <option value="<%= cat.value %>"><%= cat.label %></option>
            <% }); %>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-dark-300 mb-1">Tajuk (pilihan — nama fail digunakan jika kosong)</label>
          <input type="text" x-model="uploadForm.title" class="w-full px-3 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 bg-white dark:bg-dark-700 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Auto dari nama fail">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-dark-300 mb-2">Fail</label>
          <div class="border-2 border-dashed rounded-xl p-6 text-center border-gray-300 dark:border-dark-600 hover:border-primary-500 transition-colors cursor-pointer" @click="$refs.fileInput.click()">
            <input type="file" x-ref="fileInput" accept=".pdf,.doc,.docx,.txt" class="hidden" @change="uploadForm.file = $event.target.files[0]">
            <svg class="w-8 h-8 mx-auto text-gray-400 dark:text-dark-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
            <template x-if="uploadForm.file">
              <p class="text-sm font-medium text-primary-600 dark:text-primary-400" x-text="uploadForm.file.name"></p>
            </template>
            <template x-if="!uploadForm.file">
              <p class="text-xs text-gray-400 dark:text-dark-500">Klik untuk pilih fail atau drag & drop</p>
            </template>
            <p class="text-[10px] text-gray-400 dark:text-dark-500 mt-1">PDF, Word, TXT — Maksimum 10MB</p>
          </div>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="button" @click="showUploadModal = false" class="flex-1 px-4 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 text-sm font-medium text-gray-700 dark:text-dark-300 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors">Batal</button>
          <button type="submit" :disabled="uploading || !uploadForm.file" class="flex-1 px-4 py-2.5 rounded-xl bg-primary-600 text-white text-sm font-medium hover:bg-primary-700 shadow-lg shadow-primary-500/25 transition-all disabled:opacity-50">
            <span x-text="uploading ? 'Memproses...' : 'Upload & Indeks'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- WhatsApp Import Modal -->
  <div x-show="showWaModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50" @click="showWaModal = false"></div>
    <div class="relative bg-white dark:bg-dark-800 rounded-2xl p-6 w-full max-w-lg shadow-2xl border border-gray-200 dark:border-dark-700">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1 flex items-center gap-2">
        <svg class="w-5 h-5 text-green-500" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18a8 8 0 01-4.243-1.214l-.252-.149-2.868.852.852-2.868-.149-.252A8 8 0 1112 20z"/></svg>
        Import WhatsApp Chat
      </h3>
      <p class="text-xs text-gray-500 dark:text-dark-400 mb-5">Eksport perbualan WhatsApp → AI analisis → cipta entri KB secara automatik</p>

      <!-- Before import -->
      <template x-if="!waImporting && waResults.length === 0">
        <div class="space-y-4">
          <div class="p-4 rounded-xl bg-green-50 dark:bg-green-500/10 border border-green-200 dark:border-green-500/20">
            <h4 class="text-sm font-semibold text-green-800 dark:text-green-300 mb-2">Cara eksport dari WhatsApp:</h4>
            <ol class="text-xs text-green-700 dark:text-green-400 space-y-1 list-decimal list-inside">
              <li>Buka chat WhatsApp → ketik ⋮ (menu)</li>
              <li>Pilih <strong>Lebih banyak → Eksport chat</strong></li>
              <li>Pilih <strong>Tanpa media</strong></li>
              <li>Simpan fail .txt → upload di sini</li>
            </ol>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-dark-300 mb-2">Pilih fail .txt (boleh pilih banyak)</label>
            <div class="border-2 border-dashed rounded-xl p-6 text-center border-gray-300 dark:border-dark-600 hover:border-green-500 transition-colors cursor-pointer" @click="$refs.waFileInput.click()">
              <input type="file" x-ref="waFileInput" accept=".txt" multiple class="hidden" @change="waFiles = Array.from($event.target.files)">
              <svg class="w-8 h-8 mx-auto text-green-400 mb-2" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18a8 8 0 01-4.243-1.214l-.252-.149-2.868.852.852-2.868-.149-.252A8 8 0 1112 20z"/></svg>
              <template x-if="waFiles.length > 0">
                <div>
                  <p class="text-sm font-medium text-green-600 dark:text-green-400" x-text="waFiles.length + ' fail dipilih'"></p>
                  <template x-for="f in waFiles" :key="f.name"><p class="text-[10px] text-gray-500" x-text="f.name"></p></template>
                </div>
              </template>
              <template x-if="waFiles.length === 0">
                <p class="text-xs text-gray-400 dark:text-dark-500">Klik untuk pilih satu atau banyak fail .txt</p>
              </template>
            </div>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" @click="showWaModal = false" class="flex-1 px-4 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 text-sm font-medium text-gray-700 dark:text-dark-300 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors">Batal</button>
            <button @click="importWhatsApp()" :disabled="waFiles.length === 0" class="flex-1 px-4 py-2.5 rounded-xl bg-green-600 text-white text-sm font-medium hover:bg-green-700 shadow-lg shadow-green-500/25 transition-all disabled:opacity-50">
              Import & Analisis
            </button>
          </div>
        </div>
      </template>

      <!-- Importing -->
      <template x-if="waImporting">
        <div class="text-center py-8">
          <div class="w-12 h-12 border-4 border-green-200 border-t-green-500 rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="waProgress"></p>
          <p class="text-xs text-gray-400 dark:text-dark-500 mt-1">AI sedang menganalisis perbualan...</p>
        </div>
      </template>

      <!-- Results -->
      <template x-if="!waImporting && waResults.length > 0">
        <div class="space-y-3">
          <template x-for="r in waResults" :key="r.file">
            <div class="p-3 rounded-xl border" :class="r.status === 'success' ? 'bg-green-50 dark:bg-green-500/10 border-green-200 dark:border-green-500/20' : 'bg-red-50 dark:bg-red-500/10 border-red-200 dark:border-red-500/20'">
              <div class="flex items-center gap-2">
                <span x-text="r.status === 'success' ? '✅' : '❌'"></span>
                <span class="text-sm font-medium text-gray-900 dark:text-white" x-text="r.file"></span>
              </div>
              <template x-if="r.status === 'success'">
                <div class="mt-1 text-xs text-gray-600 dark:text-dark-300">
                  <span x-text="r.messagesFound + ' mesej'"></span> · 
                  <span x-text="r.senders + ' peserta'"></span> · 
                  <span x-text="r.entriesCreated + ' entri dicipta'"></span> · 
                  <span x-text="r.faqs + ' FAQ'"></span>
                </div>
              </template>
              <template x-if="r.status !== 'success'">
                <p class="mt-1 text-xs text-red-600 dark:text-red-400" x-text="r.reason"></p>
              </template>
            </div>
          </template>
          <div class="flex gap-3 pt-2">
            <button @click="showWaModal = false; waResults = []; waFiles = []" class="flex-1 px-4 py-2.5 rounded-xl border border-gray-300 dark:border-dark-600 text-sm font-medium text-gray-700 dark:text-dark-300 hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors">Tutup</button>
            <button @click="location.reload()" class="flex-1 px-4 py-2.5 rounded-xl bg-primary-600 text-white text-sm font-medium hover:bg-primary-700 shadow-lg shadow-primary-500/25 transition-all">Lihat Entri</button>
          </div>
        </div>
      </template>
    </div>
  </div>
</div>

<script>
function kbManager() {
  const app = {
    showModal: false,
    showUploadModal: false,
    showWaModal: false,
    editId: null,
    saving: false,
    uploading: false,
    waImporting: false,
    waProgress: '',
    waFiles: [],
    waResults: [],
    form: { category: 'FAQ', title: '', content: '' },
    uploadForm: { category: 'FAQ', title: '', file: null },

    openCreate() {
      this.editId = null;
      this.form = { category: 'FAQ', title: '', content: '' };
      this.showModal = true;
    },

    openEdit(id) {
      const item = (window.__kbItems || []).find(i => i.id === id);
      if (!item) return alert('Item not found');
      this.editId = item.id;
      this.form = { category: item.category, title: item.title, content: item.content };
      this.showModal = true;
    },

    async saveEntry() {
      this.saving = true;
      try {
        const url = this.editId ? `/api/knowledge/${this.editId}` : '/api/knowledge';
        const method = this.editId ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method, credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.form),
        });
        const data = await res.json();
        if (data.success) location.reload();
        else alert(data.error || 'Gagal');
      } catch (err) { alert('Ralat rangkaian'); }
      this.saving = false;
    },

    async deleteEntry(id) {
      if (!confirm('Padam entri ini? Embeddings juga akan dipadam.')) return;
      try {
        await fetch(`/api/knowledge/${id}`, { method: 'DELETE', credentials: 'same-origin' });
        location.reload();
      } catch (err) { alert('Gagal memadam'); }
    },

    async toggleActive(id) {
      try {
        await fetch(`/api/knowledge/${id}/toggle`, { method: 'PATCH', credentials: 'same-origin' });
        location.reload();
      } catch (err) { alert('Gagal'); }
    },

    async uploadFile() {
      if (!this.uploadForm.file) return;
      this.uploading = true;
      try {
        const fd = new FormData();
        fd.append('file', this.uploadForm.file);
        fd.append('category', this.uploadForm.category);
        if (this.uploadForm.title) fd.append('title', this.uploadForm.title);

        const res = await fetch('/api/knowledge/upload', {
          method: 'POST', credentials: 'same-origin', body: fd,
        });
        const data = await res.json();
        if (data.success) {
          alert(`Berjaya! ${data.textLength} aksara diekstrak dan diindeks.`);
          location.reload();
        } else {
          alert(data.error || 'Gagal');
        }
      } catch (err) { alert('Upload gagal'); }
      this.uploading = false;
    },

    async importWhatsApp() {
      if (this.waFiles.length === 0) return;
      this.waImporting = true;
      this.waProgress = `Mengimport ${this.waFiles.length} fail...`;
      this.waResults = [];

      try {
        const fd = new FormData();
        this.waFiles.forEach(f => fd.append('files', f));

        const res = await fetch('/api/knowledge/import-whatsapp', {
          method: 'POST', credentials: 'same-origin', body: fd,
        });
        const data = await res.json();
        if (data.success) {
          this.waResults = data.results;
        } else {
          alert(data.error || 'Import gagal');
        }
      } catch (err) { alert('Import gagal: ' + err.message); }
      this.waImporting = false;
    },
  };

  window.kbApp = app;
  return app;
}
</script>
